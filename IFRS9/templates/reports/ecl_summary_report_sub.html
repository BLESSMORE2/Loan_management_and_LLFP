{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mx-auto mt-10">
    <h1 class="text-2xl font-bold mb-8 text-gray-800 text-center">ECL Summary Report - Grouped by {{ group_by_field }}</h1>
    
    <!-- Filter Section -->
    <form method="GET" action="">
        <div class="row mb-4" style="background-color: #b4d5f6; padding: 10px; border: 1px solid #ccc;">
            <!-- Product Segment -->
            <div class="col-md-2" style="width: 15%; min-width: 150px;">
                <label for="n_prod_segment">Product Segment</label>
                <select id="n_prod_segment" name="n_prod_segment" class="form-control" style="width: 100%;">
                    <option value="">-- Select --</option>
                    {% for segment in distinct_prod_segments %}
                        <option value="{{ segment }}" {% if request.GET.n_prod_segment == segment %}selected{% endif %}>{{ segment }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Product Type -->
            <div class="col-md-2" style="width: 15%; min-width: 150px;">
                <label for="n_prod_type">Product Type</label>
                <select id="n_prod_type" name="n_prod_type" class="form-control" style="width: 100%;">
                    <option value="">-- Select --</option>
                    {% for prod_type in distinct_prod_types %}
                        <option value="{{ prod_type }}" {% if request.GET.n_prod_type == prod_type %}selected{% endif %}>{{ prod_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Stage Description -->
            <div class="col-md-2" style="width: 15%; min-width: 150px;">
                <label for="n_stage_descr">Stage Description</label>
                <select id="n_stage_descr" name="n_stage_descr" class="form-control" style="width: 100%;">
                    <option value="">-- Select --</option>
                    {% for stage_descr in distinct_stage_descrs %}
                        <option value="{{ stage_descr }}" {% if request.GET.n_stage_descr == stage_descr %}selected{% endif %}>{{ stage_descr }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Loan Type -->
            <div class="col-md-2" style="width: 15%; min-width: 150px;">
                <label for="n_loan_type">Loan Type</label>
                <select id="n_loan_type" name="n_loan_type" class="form-control" style="width: 100%;">
                    <option value="">-- Select --</option>
                    {% for loan_type in distinct_loan_types %}
                        <option value="{{ loan_type }}" {% if request.GET.n_loan_type == loan_type %}selected{% endif %}>{{ loan_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Apply Button -->
            <div class="col-md-2" style="width: 10%; display: flex; align-items: flex-end; min-width: 120px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Apply Filter</button>
            </div>
        </div>

        <!-- Group By Section -->
        <div class="row mb-4" style="background-color: #e7f5f0; padding: 10px; border: 1px solid #ccc;">
            <!-- Group By -->
            <div class="col-md-6">
                <label for="group_by_field">Group By</label>
                <select id="group_by_field" name="group_by_field" class="form-control" style="width: 100%;">
                    <option value="v_ccy_code" {% if group_by_field == 'v_ccy_code' %}selected{% endif %}>Currency Code</option>
                    <option value="n_prod_segment" {% if group_by_field == 'n_prod_segment' %}selected{% endif %}>Product Segment</option>
                    <option value="n_prod_type" {% if group_by_field == 'n_prod_type' %}selected{% endif %}>Product Type</option>
                    <option value="n_stage_descr" {% if group_by_field == 'n_stage_descr' %}selected{% endif %}>Stage Description</option>
                    <option value="n_loan_type" {% if group_by_field == 'n_loan_type' %}selected{% endif %}>Loan Type</option>
                </select>
            </div>
            <div class="col-md-2" style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn btn-success" style="width: 100%;">Apply Group By</button>
            </div>
        </div>
    </form>

    <!-- Data Table with Green Header -->
    <table class="table table-bordered table-hover table-striped mt-4" style="width: 100%; font-size: 14px;">
        <thead>
            <tr style="background-color: #71aeee; color: black; text-align: center;">
                <th colspan="1"></th> 
                <th colspan="2">EXPOSURE AT DEFAULT</th>
                <th colspan="2">EXPECTED CREDIT LOSS</th>
            </tr>
            <tr style="background-color: #2d5c8e; color: white; text-align: center;">
                <th>{{ group_by_field }}</th>
                <th>EAD Orig Currency </th>
                <th>EAD Reporting Currency</th>
                <th>12 Month Reporting ECL </th>
                <th>Lifetime Reporting ECL </th>
            </tr>
        </thead>
        <tbody>
            {% for row in grouped_data %}
            <tr>
                <td>{{ row|get_item:group_by_field }}</td>
                <td style="text-align: right;">{{ row.n_exposure_at_default_ncy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ row.n_exposure_at_default_rcy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ row.n_12m_ecl_rcy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ row.n_lifetime_ecl_rcy|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background-color: #d1e7dd; font-weight: bold;">
                <td><strong>Grand Total</strong></td>
                <td style="text-align: right;">{{ grand_totals.n_exposure_at_default_ncy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ grand_totals.n_exposure_at_default_rcy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ grand_totals.n_12m_ecl_rcy|floatformat:2 }}</td>
                <td style="text-align: right;">{{ grand_totals.n_lifetime_ecl_rcy|floatformat:2 }}</td>
            </tr>
        </tfoot>
    </table>

    <form method="POST" action="{% url 'export_ecl_report_to_excel' %}">
        {% csrf_token %}
        <button style="background-color: #3a253f; font-weight: bold;" type="submit" class="btn btn-secondary">Download Report as Excel</button>
    </form>

</div>
{% endblock %}
