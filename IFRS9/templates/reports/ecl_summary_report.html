{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-10">
    <h1 class="text-2xl font-bold mb-8 text-gray-800 text-center">ECL Summary Report</h1>

    <form method="GET" action="">
        <!-- Main Filter Section -->
        <div class="row">
            <div class="col-md-12" style="background-color: #e7f5f0; padding: 10px; border-bottom: 2px solid #ccc;">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label for="fic_mis_date">FIC MIS Date</label>
                        <select id="fic_mis_date" name="fic_mis_date" class="form-control">
                            <option value="">-- Select Date --</option>
                            {% for date in fic_mis_dates %}
                                <option value="{{ date|date:"Y-m-d" }}">{{ date|date:"Y-m-d" }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label for="n_run_key">Run Key</label>
                        <select id="n_run_key" name="n_run_key" class="form-control">
                            <option value="">-- Select Run Key --</option>
                        </select>
                    </div>
                </div>
                <!-- Apply and Reset Buttons for Main Filter -->
                <div class="row">
                    <div class="col-md-12 text-right">
                        <button type="submit" class="btn btn-primary">Apply</button>
                        <button type="reset" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sub Filter Section (Shown only if ecl_data exists) -->
        {% if ecl_data %}
        <div class="row mt-3">
            <div class="col-md-12" style="background-color: #d1e7dd; padding: 10px;">
                <div class="row">
                    <div class="col-md-2 mb-4">
                        <label for="v_ccy_code">Currency Code</label>
                        <select id="v_ccy_code" name="v_ccy_code" class="form-control">
                            <option value="">-- Select Currency --</option>
                            {% for currency in distinct_currency_codes %}
                                <option value="{{ currency }}">{{ currency }}</option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div class="col-md-2 mb-4">
                        <label for="n_prod_segment">Product Segment</label>
                        <select id="n_prod_segment" name="n_prod_segment" class="form-control">
                            <option value="">-- Select Product Segment --</option>
                            {% for segment in distinct_prod_segments %}
                                <option value="{{ segment }}">{{ segment }}</option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div class="col-md-2 mb-4">
                        <label for="n_prod_type">Product Type</label>
                        <select id="n_prod_type" name="n_prod_type" class="form-control">
                            <option value="">-- Select Product Type --</option>
                            {% for prod_type in distinct_prod_types %}
                                <option value="{{ prod_type }}">{{ prod_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div class="col-md-2 mb-4">
                        <label for="n_stage_descr">Stage Description</label>
                        <select id="n_stage_descr" name="n_stage_descr" class="form-control">
                            <option value="">-- Select Stage Description --</option>
                            {% for stage_descr in distinct_stage_descrs %}
                                <option value="{{ stage_descr }}">{{ stage_descr }}</option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div class="col-md-2 mb-4">
                        <label for="n_loan_type">Loan Type</label>
                        <select id="n_loan_type" name="n_loan_type" class="form-control">
                            <option value="">-- Select Loan Type --</option>
                            {% for loan_type in distinct_loan_types %}
                                <option value="{{ loan_type }}">{{ loan_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <!-- Apply and Reset Buttons for Sub Filter -->
                    <div class="col-md-2 text-right">
                        <button type="submit" class="btn btn-primary">Apply Sub-Filter</button>
                        <button type="reset" class="btn btn-secondary">Reset Sub-Filter</button>
                    </div>
                </div>                
            </div>
        </div>
        {% endif %}
    </form>

    <!-- Results Section -->
    {% if ecl_data %}
    <div class="mt-5">
        <h2>Filtered Data</h2>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Run Key</th>
                        <th>FIC MIS Date</th>
                        <th>Account Number</th>
                        <th>Maturity Date</th>
                        <th>Partner Name</th>
                        <th>Currency Code</th>
                        <th>Carrying Amount NCY</th>
                        <th>Carrying Amount RCY</th>
                        <th>Exposure at Default NCY</th>
                        <th>Exposure at Default RCY</th>
                        <th>12m ECL NCY</th>
                        <th>12m ECL RCY</th>
                        <th>Lifetime ECL NCY</th>
                        <th>Lifetime ECL RCY</th>
                        <th>LGD Percent</th>
                        <th>12m PD</th>
                        <th>Lifetime PD</th>
                        <th>Product Segment</th>
                        <th>Credit Rating Code</th>
                        <th>Delinquent Days</th>
                        <th>Stage Description</th>
                        <th>Product Name</th>
                        <th>Product Type</th>
                        <th>Loan Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in ecl_data %}
                    <tr>
                        <td>{{ item.n_run_key }}</td>
                        <td>{{ item.fic_mis_date }}</td>
                        <td>{{ item.n_account_number }}</td>
                        <td>{{ item.d_maturity_date }}</td>
                        <td>{{ item.n_partner_name }}</td>
                        <td>{{ item.v_ccy_code }}</td>
                        <td>{{ item.n_carrying_amount_ncy }}</td>
                        <td>{{ item.n_carrying_amount_rcy }}</td>
                        <td>{{ item.n_exposure_at_default_ncy }}</td>
                        <td>{{ item.n_exposure_at_default_rcy }}</td>
                        <td>{{ item.n_12m_ecl_ncy }}</td>
                        <td>{{ item.n_12m_ecl_rcy }}</td>
                        <td>{{ item.n_lifetime_ecl_ncy }}</td>
                        <td>{{ item.n_lifetime_ecl_rcy }}</td>
                        <td>{{ item.n_lgd_percent }}</td>
                        <td>{{ item.n_twelve_months_pd }}</td>
                        <td>{{ item.n_lifetime_pd }}</td>
                        <td>{{ item.n_prod_segment }}</td>
                        <td>{{ item.n_credit_rating_code }}</td>
                        <td>{{ item.n_delinquent_days }}</td>
                        <td>{{ item.n_stage_descr }}</td>
                        <td>{{ item.n_prod_name }}</td>
                        <td>{{ item.n_prod_type }}</td>
                        <td>{{ item.n_loan_type }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* Ensure table layout stays fixed and columns have equal width */
    table {
        table-layout: fixed;
        width: 100%;
    }

    th, td {
        white-space: nowrap; /* Prevent text wrapping */
        overflow: hidden;
        text-overflow: ellipsis; /* Add '...' if the content is too long */
        vertical-align: middle;
        padding: 10px;
        text-align: center;
        width: 220px; /* Set equal width for all columns */
    }

    /* Ensure table is scrollable */
    .table-responsive {
        max-height: 500px;
        overflow-y: scroll;
        overflow-x: auto;
    }

    /* Optional: Ensure header text is bold and easy to read */
    th {
        font-weight: bold;
        text-align: center;
    }
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page is loaded and JavaScript is running');

    // Function to convert a date string into YYYY-MM-DD format
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');  // Adding leading zero
        const day = String(date.getDate()).padStart(2, '0');  // Adding leading zero
        return `${year}-${month}-${day}`;
    }

    // Function to handle dynamic filter changes
    function updateDropdown(field, value) {
        console.log('AJAX triggered for field:', field, 'with value:', value);  // Debugging

        // Convert the date to YYYY-MM-DD format before sending it
        if (field === 'fic_mis_date') {
            value = formatDate(value);  // Format the date
            console.log('Formatted date:', value);  // Debugging formatted date
        }

        fetch(`/ecl-summary-report/?field=${field}&value=${encodeURIComponent(value)}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error: ${response.status} - ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);  // Debugging
            if (field === 'fic_mis_date') {
                const runKeyDropdown = document.getElementById('n_run_key');
                runKeyDropdown.innerHTML = ''; // Clear current options
                let defaultOption = document.createElement('option');
                defaultOption.textContent = '-- Select Run Key --';
                runKeyDropdown.appendChild(defaultOption);

                data.n_run_keys.forEach(function(runKey) {
                    let option = document.createElement('option');
                    option.value = runKey;
                    option.textContent = runKey;
                    runKeyDropdown.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error in updating dropdown:', error);
        });
    }

    // Event listener for the FIC MIS Date dropdown
    document.getElementById('fic_mis_date').addEventListener('change', function() {
        let fic_mis_date = this.value;
        console.log('FIC MIS Date selected:', fic_mis_date);  // Debugging
        updateDropdown('fic_mis_date', fic_mis_date);
    });
});
</script>
{% endblock %}
